<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–§–∏–ª–æ—Å–æ—Ñ–∏—è ‚Äî —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π —Ç–µ—Å—Ç</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050816;
      --bg-card: #0f172a;
      --accent: #6366f1;
      --accent-soft: rgba(99, 102, 241, 0.15);
      --accent-bright: #a855f7;
      --error: #f97373;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --correct: #22c55e;
      --wrong: #ef4444;
      --radius-xl: 18px;
      --shadow-soft: 0 20px 40px rgba(15, 23, 42, 0.9);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1d2442 0, #050816 60%, #020617 100%);
      color: var(--text);
    }

    .app {
      width: 100%;
      max-width: 920px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .app-title {
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-title-badge {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fb7185, #a855f7 60%, #22c55e);
      box-shadow: 0 0 18px rgba(248, 113, 113, 0.4);
    }

    .app-subtitle {
      font-size: 0.95rem;
      color: var(--muted);
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      font-size: 0.8rem;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      backdrop-filter: blur(10px);
      background: rgba(15, 23, 42, 0.6);
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.8);
    }

    .card {
      background: radial-gradient(
          circle at top left,
          rgba(148, 163, 184, 0.12),
          transparent 55%
        ),
        radial-gradient(
          circle at bottom right,
          rgba(79, 70, 229, 0.23),
          transparent 60%
        ),
        var(--bg-card);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 18px 18px 20px;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      border: 1px solid transparent;
      background: linear-gradient(
        120deg,
        rgba(129, 140, 248, 0.4),
        transparent,
        rgba(236, 72, 153, 0.4),
        transparent
      );
      opacity: 0.16;
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .loading,
    .error,
    .result {
      text-align: center;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      padding: 24px 0;
      color: var(--muted);
      font-size: 0.98rem;
    }

    .spinner {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.4);
      border-top-color: var(--accent);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .error {
      border-radius: 12px;
      border: 1px solid rgba(248, 113, 113, 0.7);
      padding: 12px 14px;
      font-size: 0.9rem;
      color: #fecaca;
      background: radial-gradient(circle at top left, rgba(248, 113, 113, 0.15), transparent 55%);
      margin-bottom: 6px;
      text-align: left;
    }

    .error-title {
      font-weight: 600;
      margin-bottom: 3px;
    }

    .error small {
      display: block;
      margin-top: 3px;
      color: #fecaca;
      opacity: 0.9;
    }

    .quiz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .question-counter {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--muted);
    }

    .chip {
      font-size: 0.8rem;
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.5);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .chip-score-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(129, 140, 248, 0.8);
    }

    .progress {
      width: 100%;
      height: 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(15, 23, 42, 1);
      overflow: hidden;
      margin-bottom: 14px;
      position: relative;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg, var(--accent), var(--accent-bright));
      box-shadow: 0 0 16px rgba(129, 140, 248, 0.7);
      transition: width 0.25s ease-out;
    }

    .question-text {
      font-size: 1.05rem;
      font-weight: 600;
      margin: 4px 0 14px;
      line-height: 1.4;
    }

    .question-meta {
      font-size: 0.82rem;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .options {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }

    .option {
      position: relative;
    }

    .option-btn {
      width: 100%;
      text-align: left;
      padding: 9px 11px 9px 12px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      font-size: 0.95rem;
      cursor: pointer;
      display: flex;
      align-items: flex-start;
      gap: 9px;
      transition:
        border-color 0.18s ease,
        box-shadow 0.18s ease,
        background 0.18s ease,
        transform 0.08s ease;
    }

    .option-btn:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.35);
      transform: translateY(-1px);
      background: radial-gradient(
          circle at top left,
          rgba(129, 140, 248, 0.18),
          transparent 55%
        ),
        rgba(15, 23, 42, 0.97);
    }

    .option-btn:active {
      transform: translateY(0);
    }

    .option-letter {
      min-width: 24px;
      height: 24px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--muted);
      background: rgba(15, 23, 42, 0.9);
      flex-shrink: 0;
      margin-top: 2px;
    }

    .option-text {
      flex: 1;
    }

    .option-selected .option-letter {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.7);
    }

    .option-correct {
      border-color: var(--correct);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.8);
      background: radial-gradient(
          circle at top left,
          rgba(34, 197, 94, 0.22),
          transparent 56%
        ),
        rgba(15, 23, 42, 0.96);
    }

    .option-correct .option-letter {
      border-color: var(--correct);
      color: var(--correct);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.9);
    }

    .option-wrong {
      border-color: var(--wrong);
      box-shadow: 0 0 0 1px rgba(239, 68, 68, 0.85);
      background: radial-gradient(
          circle at top left,
          rgba(239, 68, 68, 0.18),
          transparent 56%
        ),
        rgba(15, 23, 42, 0.96);
    }

    .option-wrong .option-letter {
      border-color: var(--wrong);
      color: var(--wrong);
      box-shadow: 0 0 0 1px rgba(239, 68, 68, 0.85);
    }

    .option-status-icon {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.1rem;
    }

    .option-status-icon.correct {
      color: var(--correct);
    }

    .option-status-icon.wrong {
      color: var(--wrong);
    }

    .warning {
      font-size: 0.85rem;
      color: #fed7aa;
      background: rgba(248, 153, 112, 0.08);
      border-radius: 8px;
      border: 1px solid rgba(248, 153, 112, 0.45);
      padding: 6px 9px;
      margin-bottom: 8px;
      display: flex;
      gap: 7px;
      align-items: center;
    }

    .warning-icon {
      font-size: 1rem;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .controls-left,
    .controls-right {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button.btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      padding: 7px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition:
        background 0.18s ease,
        border-color 0.18s ease,
        transform 0.08s ease,
        box-shadow 0.18s ease;
    }

    button.btn-primary {
      border-color: transparent;
      background: radial-gradient(
          circle at top left,
          rgba(252, 165, 165, 0.45),
          transparent 55%
        ),
        linear-gradient(135deg, var(--accent), var(--accent-bright));
      box-shadow:
        0 10px 25px rgba(15, 23, 42, 0.9),
        0 0 16px rgba(129, 140, 248, 0.8);
      font-weight: 600;
    }

    button.btn-primary:hover {
      box-shadow:
        0 14px 28px rgba(15, 23, 42, 0.95),
        0 0 20px rgba(129, 140, 248, 1);
      transform: translateY(-1px);
    }

    button.btn-secondary {
      background: rgba(15, 23, 42, 0.9);
    }

    button.btn-secondary:hover {
      background: rgba(15, 23, 42, 1);
      border-color: rgba(148, 163, 184, 1);
    }

    button.btn:active {
      transform: translateY(0);
      box-shadow: none;
    }

    button.btn:disabled {
      opacity: 0.5;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .kbd {
      font-size: 0.74rem;
      padding: 2px 7px;
      border-radius: 5px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
    }

    .result {
      text-align: center;
      padding-top: 4px;
    }

    .result-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .result-score {
      font-size: 1.05rem;
      margin-bottom: 2px;
    }

    .result-score span {
      font-weight: 700;
    }

    .result-percent {
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .result-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 11px;
      border-radius: 999px;
      font-size: 0.85rem;
      margin-bottom: 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.95);
      gap: 6px;
    }

    .result-badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 12px rgba(129, 140, 248, 0.9);
    }

    .result-details {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .result-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .app-footer {
      font-size: 0.78rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      padding: 0 4px;
    }

    .app-footer a {
      color: var(--accent);
      text-decoration: none;
      cursor: pointer;
      opacity: 0.8;
    }

    .app-footer a:hover {
      opacity: 1;
      text-decoration: underline;
    }

    @media (max-width: 640px) {
      .card {
        padding: 16px 14px 16px;
      }

      .app-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .app-title {
        font-size: 1.15rem;
      }

      .question-text {
        font-size: 1rem;
      }

      .options {
        gap: 7px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div>
        <div class="app-title">
          <div class="app-title-badge"></div>
          <span>–§–∏–ª–æ—Å–æ—Ñ–∏—è ¬∑ Quiz</span>
        </div>
        <div class="app-subtitle">
          –¢—Ä–µ–Ω–∏—Ä—É–π—Å—è –∫ —Ç–µ—Å—Ç—É: –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –∏–∑ JSON, –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—á–∏—Ç–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
        </div>
      </div>
      <div class="pill">
        <span class="pill-dot"></span>
        <span>–†–µ–∂–∏–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</span>
      </div>
    </header>

    <main class="card">
      <div class="card-inner">
        <!-- –û—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ / –ø–∞—Ä—Å–∏–Ω–≥–∞ -->
        <div id="error" class="error" hidden>
          <div class="error-title">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã üò¢</div>
          <div id="error-message"></div>
          <small>–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Ñ–∞–π–ª <strong>philosophy_all_questions.json</strong> –ª–µ–∂–∏—Ç —Ä—è–¥–æ–º —Å
            <strong>index.html</strong> –∏ –∑–∞–ø—É—Å–∫–∞–π —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, Live Server –≤ VS Code).</small>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="loading" class="loading">
          <div class="spinner"></div>
          <div>–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Ñ–∏–ª–æ—Å–æ—Ñ–∏–∏‚Ä¶</div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–≤–∏–∑ -->
        <div id="quiz" hidden>
          <div class="quiz-header">
            <div class="question-counter" id="question-counter"></div>
            <div class="chip">
              <div class="chip-score-dot"></div>
              <span id="score-preview">0 / 0 –≤–µ—Ä–Ω—ã—Ö</span>
            </div>
          </div>

          <div class="progress">
            <div class="progress-bar" id="progress-bar"></div>
          </div>

          <div class="question-meta" id="question-meta"></div>
          <div class="question-text" id="question-text"></div>

          <div class="options" id="options"></div>

          <div id="warning" class="warning" hidden>
            <span class="warning-icon">‚ö†Ô∏è</span>
            <span>–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞.</span>
          </div>

          <div class="controls">
            <div class="controls-left">
              <button id="btn-prev" class="btn btn-secondary">
                ‚¨Ö –ù–∞–∑–∞–¥
              </button>
              <button id="btn-restart-soft" class="btn btn-secondary">
                ‚ü≥ –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
              </button>
            </div>
            <div class="controls-right">
              <span class="kbd">Enter ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å / –¥–∞–ª—å—à–µ</span>
              <button id="btn-main" class="btn btn-primary">
                –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
              </button>
            </div>
          </div>
        </div>

        <!-- –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç -->
        <div id="result" class="result" hidden>
          <div class="result-title">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è</div>
          <div class="result-score">
            –¢—ã –æ—Ç–≤–µ—Ç–∏–ª(–∞) –≤–µ—Ä–Ω–æ –Ω–∞ <span id="result-correct"></span> –∏–∑
            <span id="result-total"></span> –≤–æ–ø—Ä–æ—Å–æ–≤.
          </div>
          <div class="result-percent">
            –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <span id="result-percent"></span>%
          </div>
          <div class="result-badge">
            <div class="result-badge-dot"></div>
            <span id="result-label"></span>
          </div>
          <div class="result-details" id="result-details"></div>
          <div class="result-actions">
            <button id="btn-restart" class="btn btn-primary">–ü—Ä–æ–π—Ç–∏ –µ—â—ë —Ä–∞–∑</button>
            <button id="btn-review" class="btn btn-secondary">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ–ø—Ä–æ—Å—ã</button>
          </div>
        </div>
      </div>
    </main>

    <footer class="app-footer">
      <span>–§–∞–π–ª: <strong>philosophy_all_questions.json</strong></span>
      <span>–ü–æ–¥—Å–∫–∞–∑–∫–∞: –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, Live Server).</span>
    </footer>
  </div>

  <script>
    // ====== –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï –ö–í–ò–ó–ê ======
    const state = {
      questions: [],
      currentIndex: 0,
      answers: [], // { selected: 'A' | 'B' | ... | null, isCorrect: boolean | null }
      loaded: false
    };

    // ====== –≠–õ–ï–ú–ï–ù–¢–´ DOM ======
    const elLoading = document.getElementById('loading');
    const elError = document.getElementById('error');
    const elErrorMessage = document.getElementById('error-message');

    const elQuiz = document.getElementById('quiz');
    const elResult = document.getElementById('result');

    const elQuestionCounter = document.getElementById('question-counter');
    const elScorePreview = document.getElementById('score-preview');
    const elProgressBar = document.getElementById('progress-bar');
    const elQuestionMeta = document.getElementById('question-meta');
    const elQuestionText = document.getElementById('question-text');
    const elOptions = document.getElementById('options');
    const elWarning = document.getElementById('warning');

    const btnPrev = document.getElementById('btn-prev');
    const btnMain = document.getElementById('btn-main');
    const btnRestartSoft = document.getElementById('btn-restart-soft');
    const btnRestart = document.getElementById('btn-restart');
    const btnReview = document.getElementById('btn-review');

    const elResultCorrect = document.getElementById('result-correct');
    const elResultTotal = document.getElementById('result-total');
    const elResultPercent = document.getElementById('result-percent');
    const elResultLabel = document.getElementById('result-label');
    const elResultDetails = document.getElementById('result-details');

    // mainMode: 'check' (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π), 'next' (–∫ —Å–ª–µ–¥—É—é—â–µ–º—É), 'finish' (–∑–∞–≤–µ—Ä—à–∏—Ç—å)
    let mainMode = 'check';

    // ====== –ó–ê–ì–†–£–ó–ö–ê –í–û–ü–†–û–°–û–í –ò–ó JSON ======
    async function loadQuestions() {
      showLoading(true);
      showError(null);

      try {
        const res = await fetch('philosophy_all_questions.json', {
          cache: 'no-store'
        });

        if (!res.ok) {
          throw new Error('HTTP ' + res.status + ' ‚Äî ' + res.statusText);
        }

        const data = await res.json();

        if (!Array.isArray(data)) {
          throw new Error('–û–∂–∏–¥–∞–ª—Å—è –º–∞—Å—Å–∏–≤ –≤–æ–ø—Ä–æ—Å–æ–≤, –Ω–æ –ø—Ä–∏—à–ª–æ —á—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–µ.');
        }

        if (data.length === 0) {
          throw new Error('–í —Ñ–∞–π–ª–µ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.');
        }

        state.questions = data.map((q, index) => ({
          ...q,
          _index: index + 1
        }));

        state.currentIndex = 0;
        state.answers = state.questions.map(() => ({
          selected: null,
          isCorrect: null
        }));
        state.loaded = true;

        showLoading(false);
        showQuiz(true);
        renderCurrentQuestion();
        updateScorePreview();
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JSON:', err);
        showLoading(false);
        showError(err.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞.');
      }
    }

    function showLoading(isLoading) {
      elLoading.hidden = !isLoading;
    }

    function showError(message) {
      if (!message) {
        elError.hidden = true;
        elErrorMessage.textContent = '';
        return;
      }
      elError.hidden = false;
      elErrorMessage.textContent = message;
    }

    function showQuiz(show) {
      elQuiz.hidden = !show;
      elResult.hidden = true;
    }

    function showResult() {
      elQuiz.hidden = true;
      elResult.hidden = false;

      const total = state.questions.length;
      const correct = state.answers.filter(a => a.isCorrect === true).length;
      const percent = Math.round((correct / total) * 100);

      elResultCorrect.textContent = correct;
      elResultTotal.textContent = total;
      elResultPercent.textContent = percent;

      let label;
      if (percent >= 90) label = '–ë–æ–≥ —Ñ–∏–ª–æ—Å–æ—Ñ–∏–∏ üòé';
      else if (percent >= 75) label = '–û—á–µ–Ω—å –∫—Ä—É—Ç–æ, –µ—â—ë —á—É—Ç—å-—á—É—Ç—å ‚Äî –∏ —Ç–æ–ø!';
      else if (percent >= 60) label = '–ù–µ–ø–ª–æ—Ö–æ, –Ω–æ –º–æ–∂–Ω–æ –ª—É—á—à–µ ‚Äî –ø—Ä–æ–π–¥–∏ –µ—â—ë —Ä–∞–∑.';
      else label = '–ù–æ—Ä–º –∫–∞–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞, –Ω–æ –Ω—É–∂–Ω–æ –ø–æ–¥—Ç—è–Ω—É—Ç—å —Ç–µ–º—ã.';

      elResultLabel.textContent = label;

      const wrong = total - correct;
      elResultDetails.textContent =
        `–í–µ—Ä–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${correct}, –æ—à–∏–±–æ–∫: ${wrong}. ` +
        `–ú–æ–∂–Ω–æ –ø–µ—Ä–µ—Å–¥–∞—Ç—å —Ç–µ—Å—Ç –∏ —Å–ª–µ–¥–∏—Ç—å –∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º –ø–æ —Ç–µ–º–∞–º.`;

      mainMode = 'finish';
    }

    // ====== –û–¢–†–ò–°–û–í–ö–ê –¢–ï–ö–£–©–ï–ì–û –í–û–ü–†–û–°–ê ======
    function renderCurrentQuestion() {
      const q = state.questions[state.currentIndex];
      const aState = state.answers[state.currentIndex];

      // –°—á—ë—Ç—á–∏–∫ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å
      const total = state.questions.length;
      const num = state.currentIndex + 1;

      elQuestionCounter.textContent = `–í–æ–ø—Ä–æ—Å ${num} –∏–∑ ${total}`;
      elProgressBar.style.width = `${(num / total) * 100}%`;

      // –ú–µ—Ç–∞ / ID
      elQuestionMeta.textContent = `ID: ${q.id ?? q._index}`;

      // –¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞
      elQuestionText.textContent = q.question ?? '–ë–µ–∑ —Ç–µ–∫—Å—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞ (–ø—Ä–æ–≤–µ—Ä—å JSON).';

      // –í–∞—Ä–∏–∞–Ω—Ç—ã
      elOptions.innerHTML = '';

      const optionsObj = q.options || {};
      const entries = Object.entries(optionsObj).sort((a, b) =>
        a[0].localeCompare(b[0])
      );

      entries.forEach(([letter, text]) => {
        const optionEl = document.createElement('div');
        optionEl.className = 'option';

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'option-btn';
        btn.dataset.letter = letter;

        const letterSpan = document.createElement('div');
        letterSpan.className = 'option-letter';
        letterSpan.textContent = letter;

        const textSpan = document.createElement('div');
        textSpan.className = 'option-text';
        textSpan.textContent = text;

        btn.appendChild(letterSpan);
        btn.appendChild(textSpan);
        optionEl.appendChild(btn);

        // –ò–∫–æ–Ω–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ (–ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏)
        const statusIcon = document.createElement('div');
        statusIcon.className = 'option-status-icon';
        optionEl.appendChild(statusIcon);

        btn.addEventListener('click', () => handleOptionClick(letter));

        elOptions.appendChild(optionEl);
      });

      // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é (–≤—ã–±–æ—Ä –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å)
      applyOptionStyles();

      // –ö–Ω–æ–ø–∫–∏
      btnPrev.disabled = state.currentIndex === 0;
      updateMainButtonMode();

      // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
      setWarning(false);
    }

    function applyOptionStyles() {
      const aState = state.answers[state.currentIndex];
      const q = state.questions[state.currentIndex];

      const optionNodes = elOptions.querySelectorAll('.option');
      optionNodes.forEach(optionEl => {
        const btn = optionEl.querySelector('.option-btn');
        const letterSpan = optionEl.querySelector('.option-letter');
        const icon = optionEl.querySelector('.option-status-icon');
        const letter = btn.dataset.letter;

        optionEl.classList.remove('option-selected');
        btn.classList.remove('option-correct', 'option-wrong');
        icon.textContent = '';
        icon.className = 'option-status-icon';

        // –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
        if (aState.selected === letter) {
          optionEl.classList.add('option-selected');
        }

        // –µ—Å–ª–∏ —É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if (aState.isCorrect !== null) {
          if (letter === q.answer) {
            btn.classList.add('option-correct');
            icon.textContent = '‚úî';
            icon.classList.add('correct');
          } else if (letter === aState.selected) {
            btn.classList.add('option-wrong');
            icon.textContent = '‚úñ';
            icon.classList.add('wrong');
          }
        }
      });
    }

    // ====== –õ–û–ì–ò–ö–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø ======
    function handleOptionClick(letter) {
      const aState = state.answers[state.currentIndex];

      // –ï—Å–ª–∏ —É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ ‚Äî –Ω–µ –¥–∞—ë–º –º–µ–Ω—è—Ç—å –æ—Ç–≤–µ—Ç
      if (aState.isCorrect !== null) return;

      aState.selected = letter;
      applyOptionStyles();
      setWarning(false);
    }

    function setWarning(show) {
      elWarning.hidden = !show;
    }

    function updateScorePreview() {
      const totalChecked = state.answers.filter(a => a.isCorrect !== null).length;
      const correct = state.answers.filter(a => a.isCorrect === true).length;

      if (totalChecked === 0) {
        elScorePreview.textContent = '0 / 0 –≤–µ—Ä–Ω—ã—Ö';
      } else {
        elScorePreview.textContent = `${correct} / ${totalChecked} –≤–µ—Ä–Ω—ã—Ö`;
      }
    }

    function updateMainButtonMode() {
      const aState = state.answers[state.currentIndex];
      const last = state.currentIndex === state.questions.length - 1;

      if (aState.isCorrect === null) {
        mainMode = 'check';
        btnMain.textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
      } else if (!last) {
        mainMode = 'next';
        btnMain.textContent = '–î–∞–ª—å—à–µ';
      } else {
        mainMode = 'finish';
        btnMain.textContent = '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç';
      }
    }

    function handlePrev() {
      if (state.currentIndex === 0) return;
      state.currentIndex--;
      renderCurrentQuestion();
    }

    function handleMainButton() {
      const aState = state.answers[state.currentIndex];
      const q = state.questions[state.currentIndex];

      if (mainMode === 'check') {
        if (!aState.selected) {
          setWarning(true);
          return;
        }
        aState.isCorrect = aState.selected === q.answer;
        applyOptionStyles();
        updateScorePreview();
        updateMainButtonMode();
      } else if (mainMode === 'next') {
        if (state.currentIndex < state.questions.length - 1) {
          state.currentIndex++;
          renderCurrentQuestion();
        }
      } else if (mainMode === 'finish') {
        showResult();
      }
    }

    function softRestart() {
      if (!state.loaded || state.questions.length === 0) return;

      state.currentIndex = 0;
      state.answers = state.questions.map(() => ({
        selected: null,
        isCorrect: null
      }));

      renderCurrentQuestion();
      updateScorePreview();
      showQuiz(true);
    }

    function hardRestart() {
      // –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å JSON (–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø—Ä–æ—Å—Ç–æ softRestart, –Ω–æ —Ç–∞–∫ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ)
      state.questions = [];
      state.answers = [];
      state.currentIndex = 0;
      state.loaded = false;
      showResult(false);
      showQuiz(false);
      loadQuestions();
    }

    function showResult(show) {
      if (typeof show === 'boolean') {
        elResult.hidden = !show;
        return;
      }
      // –∏–Ω–∞—á–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ showResult())
      elResult.hidden = false;
    }

    // ====== –û–ë–†–ê–ë–û–¢–ö–ê –°–û–ë–´–¢–ò–ô ======
    btnPrev.addEventListener('click', handlePrev);
    btnMain.addEventListener('click', handleMainButton);
    btnRestartSoft.addEventListener('click', softRestart);
    btnRestart.addEventListener('click', hardRestart);
    btnReview.addEventListener('click', () => {
      // –ø–æ—Å–ª–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–±–∑–æ—Ä—É –≤–æ–ø—Ä–æ—Å–æ–≤
      state.currentIndex = 0;
      renderCurrentQuestion();
      showQuiz(true);
    });

    // Enter ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å/–¥–∞–ª—å—à–µ/–∑–∞–≤–µ—Ä—à–∏—Ç—å
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        // —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—å –ø–æ Enter –≤ –∏–Ω–ø—É—Ç–∞—Ö (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ –¥–æ–±–∞–≤–∏—à—å)
        if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) {
          return;
        }
        e.preventDefault();
        if (!elQuiz.hidden) {
          handleMainButton();
        }
      }
    });

    // ====== –°–¢–ê–†–¢ –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –°–¢–†–ê–ù–ò–¶–´ ======
    loadQuestions();
  </script>
</body>
</html>
