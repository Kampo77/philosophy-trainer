<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Philosophy Quiz ‚Äî Practice & Exam Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050816;
      --bg-card: #0f172a;
      --accent: #6366f1;
      --accent-soft: rgba(99, 102, 241, 0.15);
      --accent-bright: #a855f7;
      --error: #f97373;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --correct: #22c55e;
      --wrong: #ef4444;
      --radius-xl: 18px;
      --shadow-soft: 0 20px 40px rgba(15, 23, 42, 0.9);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1d2442 0, #050816 60%, #020617 100%);
      color: var(--text);
    }

    .app {
      width: 100%;
      max-width: 980px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .app-title {
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-title-badge {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fb7185, #a855f7 60%, #22c55e);
      box-shadow: 0 0 18px rgba(248, 113, 113, 0.4);
    }

    .app-subtitle {
      font-size: 0.95rem;
      color: var(--muted);
      max-width: 520px;
    }

    .header-right {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
    }

    .mode-switch {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      backdrop-filter: blur(10px);
    }

    .mode-btn {
      border: none;
      outline: none;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.8rem;
      cursor: pointer;
      color: var(--muted);
      background: transparent;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition:
        background 0.18s ease,
        color 0.18s ease,
        box-shadow 0.18s ease,
        transform 0.08s ease;
    }

    .mode-btn span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: transparent;
    }

    .mode-btn-active {
      background: radial-gradient(
          circle at top left,
          rgba(129, 140, 248, 0.4),
          transparent 55%
        ),
        linear-gradient(135deg, #1f2937, #020617);
      color: #e5e7eb;
      box-shadow:
        0 8px 18px rgba(15, 23, 42, 0.8),
        0 0 12px rgba(129, 140, 248, 0.9);
      transform: translateY(-1px);
    }

    .mode-btn-active span.dot {
      background: #22c55e;
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.9);
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      font-size: 0.8rem;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      backdrop-filter: blur(10px);
      background: rgba(15, 23, 42, 0.6);
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.8);
    }

    .card {
      background: radial-gradient(
          circle at top left,
          rgba(148, 163, 184, 0.12),
          transparent 55%
        ),
        radial-gradient(
          circle at bottom right,
          rgba(79, 70, 229, 0.23),
          transparent 60%
        ),
        var(--bg-card);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 18px 18px 20px;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      border: 1px solid transparent;
      background: linear-gradient(
        120deg,
        rgba(129, 140, 248, 0.4),
        transparent,
        rgba(236, 72, 153, 0.4),
        transparent
      );
      opacity: 0.16;
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .loading,
    .error,
    .result {
      text-align: center;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      padding: 24px 0;
      color: var(--muted);
      font-size: 0.98rem;
    }

    .spinner {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.4);
      border-top-color: var(--accent);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .error {
      border-radius: 12px;
      border: 1px solid rgba(248, 113, 113, 0.7);
      padding: 12px 14px;
      font-size: 0.9rem;
      color: #fecaca;
      background: radial-gradient(circle at top left, rgba(248, 113, 113, 0.15), transparent 55%);
      margin-bottom: 6px;
      text-align: left;
    }

    .error-title {
      font-weight: 600;
      margin-bottom: 3px;
    }

    .error small {
      display: block;
      margin-top: 3px;
      color: #fecaca;
      opacity: 0.9;
    }

    .quiz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .question-counter {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--muted);
    }

    .chip {
      font-size: 0.8rem;
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.5);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .chip-score-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(129, 140, 248, 0.8);
    }

    .progress {
      width: 100%;
      height: 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(15, 23, 42, 1);
      overflow: hidden;
      margin-bottom: 12px;
      position: relative;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg, var(--accent), var(--accent-bright));
      box-shadow: 0 0 16px rgba(129, 140, 248, 0.7);
      transition: width 0.25s ease-out;
    }

    /* Exam bar */

    .exam-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.35);
      margin-bottom: 10px;
      font-size: 0.8rem;
      flex-wrap: wrap;
    }

    .exam-bar-left {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .exam-label {
      font-weight: 600;
      color: var(--muted);
    }

    .exam-field {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .exam-field span {
      color: var(--muted);
    }

    .exam-select {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      padding: 3px 7px;
      font-size: 0.8rem;
      color: var(--text);
      outline: none;
    }

    .exam-bar-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .exam-status {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .exam-status-pill {
      border-radius: 999px;
      padding: 3px 8px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .exam-timer {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 0.82rem;
      border-radius: 999px;
      padding: 3px 9px;
      border: 1px solid rgba(248, 250, 252, 0.4);
      background: radial-gradient(
          circle at top left,
          rgba(248, 113, 113, 0.3),
          transparent 55%
        ),
        rgba(15, 23, 42, 0.95);
      color: #fee2e2;
      box-shadow: 0 0 12px rgba(248, 113, 113, 0.8);
    }

    .question-text {
      font-size: 1.05rem;
      font-weight: 600;
      margin: 4px 0 10px;
      line-height: 1.4;
    }

    .question-meta {
      font-size: 0.82rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .options {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }

    .option {
      position: relative;
    }

    .option-btn {
      width: 100%;
      text-align: left;
      padding: 9px 11px 9px 12px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      font-size: 0.95rem;
      cursor: pointer;
      display: flex;
      align-items: flex-start;
      gap: 9px;
      transition:
        border-color 0.18s ease,
        box-shadow 0.18s ease,
        background 0.18s ease,
        transform 0.08s ease;
    }

    .option-btn:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.35);
      transform: translateY(-1px);
      background: radial-gradient(
          circle at top left,
          rgba(129, 140, 248, 0.18),
          transparent 55%
        ),
        rgba(15, 23, 42, 0.97);
    }

    .option-btn:active {
      transform: translateY(0);
    }

    .option-letter {
      min-width: 24px;
      height: 24px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--muted);
      background: rgba(15, 23, 42, 0.9);
      flex-shrink: 0;
      margin-top: 2px;
    }

    .option-text {
      flex: 1;
    }

    .option-selected .option-letter {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.7);
    }

    .option-correct {
      border-color: var(--correct);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.8);
      background: radial-gradient(
          circle at top left,
          rgba(34, 197, 94, 0.22),
          transparent 56%
        ),
        rgba(15, 23, 42, 0.96);
    }

    .option-correct .option-letter {
      border-color: var(--correct);
      color: var(--correct);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.9);
    }

    .option-wrong {
      border-color: var(--wrong);
      box-shadow: 0 0 0 1px rgba(239, 68, 68, 0.85);
      background: radial-gradient(
          circle at top left,
          rgba(239, 68, 68, 0.18),
          transparent 56%
        ),
        rgba(15, 23, 42, 0.96);
    }

    .option-wrong .option-letter {
      border-color: var(--wrong);
      color: var(--wrong);
      box-shadow: 0 0 0 1px rgba(239, 68, 68, 0.85);
    }

    .option-status-icon {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.1rem;
    }

    .option-status-icon.correct {
      color: var(--correct);
    }

    .option-status-icon.wrong {
      color: var(--wrong);
    }

    .warning {
      font-size: 0.85rem;
      color: #fed7aa;
      background: rgba(248, 153, 112, 0.08);
      border-radius: 8px;
      border: 1px solid rgba(248, 153, 112, 0.45);
      padding: 6px 9px;
      margin-bottom: 8px;
      display: flex;
      gap: 7px;
      align-items: center;
    }

    .warning-icon {
      font-size: 1rem;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .controls-left,
    .controls-right {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    button.btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      padding: 7px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition:
        background 0.18s ease,
        border-color 0.18s ease,
        transform 0.08s ease,
        box-shadow 0.18s ease;
    }

    button.btn-primary {
      border-color: transparent;
      background: radial-gradient(
          circle at top left,
          rgba(252, 165, 165, 0.45),
          transparent 55%
        ),
        linear-gradient(135deg, var(--accent), var(--accent-bright));
      box-shadow:
        0 10px 25px rgba(15, 23, 42, 0.9),
        0 0 16px rgba(129, 140, 248, 0.8);
      font-weight: 600;
    }

    button.btn-primary:hover {
      box-shadow:
        0 14px 28px rgba(15, 23, 42, 0.95),
        0 0 20px rgba(129, 140, 248, 1);
      transform: translateY(-1px);
    }

    button.btn-secondary {
      background: rgba(15, 23, 42, 0.9);
    }

    button.btn-secondary:hover {
      background: rgba(15, 23, 42, 1);
      border-color: rgba(148, 163, 184, 1);
    }

    button.btn:active {
      transform: translateY(0);
      box-shadow: none;
    }

    button.btn:disabled {
      opacity: 0.5;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .kbd {
      font-size: 0.74rem;
      padding: 2px 7px;
      border-radius: 5px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
    }

    .result {
      text-align: center;
      padding-top: 4px;
    }

    .result-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .result-score {
      font-size: 1.05rem;
      margin-bottom: 2px;
    }

    .result-score span {
      font-weight: 700;
    }

    .result-percent {
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .result-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 11px;
      border-radius: 999px;
      font-size: 0.85rem;
      margin-bottom: 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.95);
      gap: 6px;
    }

    .result-badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 12px rgba(129, 140, 248, 0.9);
    }

    .result-details {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .result-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .app-footer {
      font-size: 0.78rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      padding: 0 4px;
      flex-wrap: wrap;
    }

    .app-footer a {
      color: var(--accent);
      text-decoration: none;
      cursor: pointer;
      opacity: 0.8;
    }

    .app-footer a:hover {
      opacity: 1;
      text-decoration: underline;
    }

    @media (max-width: 640px) {
      .card {
        padding: 16px 14px 16px;
      }

      .app-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .header-right {
        align-items: flex-start;
      }

      .app-title {
        font-size: 1.15rem;
      }

      .question-text {
        font-size: 1rem;
      }

      .options {
        gap: 7px;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      .controls-left,
      .controls-right {
        justify-content: space-between;
      }

      .controls-right {
        justify-content: flex-end;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div>
        <div class="app-title">
          <div class="app-title-badge"></div>
          <span>Philosophy ¬∑ Quiz</span>
        </div>
        <div class="app-subtitle">
          Use your JSON bank to drill questions in Practice mode or simulate a real Exam with a timer and hidden answers.
        </div>
      </div>
      <div class="header-right">
        <div class="mode-switch">
          <button id="btn-mode-practice" class="mode-btn mode-btn-active">
            <span class="dot"></span>
            <span>Practice</span>
          </button>
          <button id="btn-mode-exam" class="mode-btn">
            <span class="dot"></span>
            <span>Exam</span>
          </button>
        </div>
        <div class="pill">
          <span class="pill-dot"></span>
          <span id="mode-pill-text">Practice mode</span>
        </div>
      </div>
    </header>

    <main class="card">
      <div class="card-inner">
        <!-- Errors -->
        <div id="error" class="error" hidden>
          <div class="error-title">Failed to load questions üò¢</div>
          <div id="error-message"></div>
          <small>
            Make sure <strong>philosophy_all_questions.json</strong> is in the same folder as
            <strong>index.html</strong> and open the page via a local server (for example, VS Code Live Server).
          </small>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading">
          <div class="spinner"></div>
          <div>Loading philosophy questions from JSON‚Ä¶</div>
        </div>

        <!-- Quiz -->
        <div id="quiz" hidden>
          <div class="quiz-header">
            <div class="question-counter" id="question-counter"></div>
            <div class="chip">
              <div class="chip-score-dot"></div>
              <span id="score-preview">No answers yet</span>
            </div>
          </div>

          <!-- Exam bar (visible only in Exam mode) -->
          <div id="exam-bar" class="exam-bar" hidden>
            <div class="exam-bar-left">
              <span class="exam-label">Exam settings</span>
              <div class="exam-field">
                <span>Questions:</span>
                <select id="exam-question-count" class="exam-select">
                  <option value="all">All</option>
                  <option value="10">10</option>
                  <option value="20">20</option>
                  <option value="30">30</option>
                  <option value="40">40</option>
                </select>
              </div>
              <div class="exam-field">
                <span>Duration:</span>
                <select id="exam-duration" class="exam-select">
                  <option value="0">No limit</option>
                  <option value="30">30 min</option>
                  <option value="45">45 min</option>
                  <option value="60">60 min</option>
                </select>
              </div>
            </div>
            <div class="exam-bar-right">
              <div id="exam-status" class="exam-status exam-status-pill">
                Exam not started
              </div>
              <div id="exam-timer" class="exam-timer" hidden>00:00</div>
            </div>
          </div>

          <div class="progress">
            <div class="progress-bar" id="progress-bar"></div>
          </div>

          <div class="question-meta" id="question-meta"></div>
          <div class="question-text" id="question-text"></div>

          <div class="options" id="options"></div>

          <div id="warning" class="warning" hidden>
            <span class="warning-icon">‚ö†Ô∏è</span>
            <span>Please select an answer first.</span>
          </div>

          <div class="controls">
            <div class="controls-left">
              <button id="btn-prev" class="btn btn-secondary">
                ‚Üê Previous
              </button>
              <button id="btn-restart-soft" class="btn btn-secondary">
                ‚ü≥ Reset current run
              </button>
            </div>
            <div class="controls-right">
              <span class="kbd">Enter ‚Äî main action</span>
              <button id="btn-main" class="btn btn-primary">
                Check answer
              </button>
            </div>
          </div>
        </div>

        <!-- Result -->
        <div id="result" class="result" hidden>
          <div class="result-title">Your result</div>
          <div class="result-score">
            Correct answers: <span id="result-correct"></span> /
            <span id="result-total"></span>
          </div>
          <div class="result-percent">
            Accuracy: <span id="result-percent"></span>%
          </div>
          <div class="result-badge">
            <div class="result-badge-dot"></div>
            <span id="result-label"></span>
          </div>
          <div class="result-details" id="result-details"></div>
          <div class="result-actions">
            <button id="btn-restart" class="btn btn-primary">Restart (same mode)</button>
            <button id="btn-review" class="btn btn-secondary">Review questions</button>
          </div>
        </div>
      </div>
    </main>

    <footer class="app-footer">
      <span>Using file: <strong>philosophy_all_questions.json</strong></span>
      <span>Tip: open this HTML via local server to avoid CORS issues.</span>
    </footer>
  </div>

  <script>
    // ====== GLOBAL QUIZ STATE ======
    const MODES = {
      PRACTICE: "practice",
      EXAM: "exam",
    };

    const state = {
      allQuestions: [],
      questions: [],
      currentIndex: 0,
      answers: [], // { selected: 'A' | ... | null, isCorrect: boolean | null }
      loaded: false,
      mode: MODES.PRACTICE,
      exam: {
        active: false,
        finished: false,
        timedOut: false,
        totalSeconds: 0,
        remainingSeconds: 0,
        timerId: null,
        config: {
          questionCount: "all",
          durationMinutes: 0,
        },
      },
    };

    // ====== DOM ELEMENTS ======
    const elLoading = document.getElementById("loading");
    const elError = document.getElementById("error");
    const elErrorMessage = document.getElementById("error-message");

    const elQuiz = document.getElementById("quiz");
    const elResult = document.getElementById("result");

    const elQuestionCounter = document.getElementById("question-counter");
    const elScorePreview = document.getElementById("score-preview");
    const elProgressBar = document.getElementById("progress-bar");
    const elQuestionMeta = document.getElementById("question-meta");
    const elQuestionText = document.getElementById("question-text");
    const elOptions = document.getElementById("options");
    const elWarning = document.getElementById("warning");

    const btnPrev = document.getElementById("btn-prev");
    const btnMain = document.getElementById("btn-main");
    const btnRestartSoft = document.getElementById("btn-restart-soft");
    const btnRestart = document.getElementById("btn-restart");
    const btnReview = document.getElementById("btn-review");

    const elResultCorrect = document.getElementById("result-correct");
    const elResultTotal = document.getElementById("result-total");
    const elResultPercent = document.getElementById("result-percent");
    const elResultLabel = document.getElementById("result-label");
    const elResultDetails = document.getElementById("result-details");

    const elExamBar = document.getElementById("exam-bar");
    const elExamStatus = document.getElementById("exam-status");
    const elExamTimer = document.getElementById("exam-timer");
    const examQuestionCountSelect = document.getElementById("exam-question-count");
    const examDurationSelect = document.getElementById("exam-duration");

    const btnModePractice = document.getElementById("btn-mode-practice");
    const btnModeExam = document.getElementById("btn-mode-exam");
    const elModePillText = document.getElementById("mode-pill-text");

    // ====== HELPERS ======
    function showLoading(isLoading) {
      elLoading.hidden = !isLoading;
    }

    function showError(message) {
      if (!message) {
        elError.hidden = true;
        elErrorMessage.textContent = "";
        return;
      }
      elError.hidden = false;
      elErrorMessage.textContent = message;
    }

    function setWarning(show) {
      elWarning.hidden = !show;
    }

    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function formatTime(seconds) {
      const s = Math.max(0, Math.floor(seconds));
      const m = Math.floor(s / 60);
      const sec = s % 60;
      const mm = String(m).padStart(2, "0");
      const ss = String(sec).padStart(2, "0");
      return `${mm}:${ss}`;
    }

    // ====== MODE HANDLING ======
    function updateUIForMode() {
      if (state.mode === MODES.PRACTICE) {
        btnModePractice.classList.add("mode-btn-active");
        btnModeExam.classList.remove("mode-btn-active");
        elModePillText.textContent = "Practice mode";
        elExamBar.hidden = true;
      } else {
        btnModePractice.classList.remove("mode-btn-active");
        btnModeExam.classList.add("mode-btn-active");
        elModePillText.textContent = "Exam mode";
        elExamBar.hidden = false;
      }
    }

    function setMode(mode) {
      if (mode === state.mode) return;

      // clear exam timer when leaving exam
      if (state.mode === MODES.EXAM) {
        clearExamTimer();
      }

      state.mode = mode;
      updateUIForMode();

      if (!state.loaded || !state.allQuestions.length) {
        return;
      }

      if (mode === MODES.PRACTICE) {
        enterPracticeMode();
      } else {
        enterExamMode();
      }
    }

    function enterPracticeMode() {
      // use full original question set in original order
      state.questions = state.allQuestions
        .slice()
        .sort((a, b) => (a._index || 0) - (b._index || 0));
      state.answers = state.questions.map(() => ({
        selected: null,
        isCorrect: null,
      }));
      state.currentIndex = 0;

      // reset exam state
      state.exam.active = false;
      state.exam.finished = false;
      state.exam.timedOut = false;
      clearExamTimer();
      updateExamStatus();

      elResult.hidden = true;
      elQuiz.hidden = false;
      renderCurrentQuestion();
      updateScorePreview();
    }

    function enterExamMode() {
      // reset exam but do not start yet
      state.exam.active = false;
      state.exam.finished = false;
      state.exam.timedOut = false;
      clearExamTimer();

      state.questions = [];
      state.answers = [];
      state.currentIndex = 0;

      elResult.hidden = true;
      elQuiz.hidden = false;
      updateExamStatus();
      renderCurrentQuestion();
      updateScorePreview();
    }

    // ====== EXAM TIMER ======
    function clearExamTimer() {
      if (state.exam.timerId) {
        clearInterval(state.exam.timerId);
        state.exam.timerId = null;
      }
    }

    function updateTimerDisplay() {
      if (state.mode !== MODES.EXAM) {
        elExamTimer.hidden = true;
        return;
      }
      if (!state.exam.active && !state.exam.finished) {
        elExamTimer.hidden = true;
        return;
      }
      if (state.exam.totalSeconds <= 0) {
        elExamTimer.hidden = true;
        return;
      }
      elExamTimer.hidden = false;
      elExamTimer.textContent = formatTime(state.exam.remainingSeconds);
    }

    function startExamTimer() {
      clearExamTimer();
      updateTimerDisplay();
      state.exam.timerId = setInterval(() => {
        if (!state.exam.active) {
          clearExamTimer();
          return;
        }
        state.exam.remainingSeconds -= 1;
        if (state.exam.remainingSeconds <= 0) {
          state.exam.remainingSeconds = 0;
          updateTimerDisplay();
          clearExamTimer();
          finishExam(true);
        } else {
          updateTimerDisplay();
        }
      }, 1000);
    }

    // ====== EXAM STATUS ======
    function updateExamStatus() {
      if (state.mode !== MODES.EXAM) {
        // nothing special
        return;
      }

      if (!state.exam.active && !state.exam.finished) {
        elExamStatus.textContent = "Exam not started";
      } else if (state.exam.active && !state.exam.finished) {
        elExamStatus.textContent = "Exam in progress";
      } else if (state.exam.finished) {
        elExamStatus.textContent = state.exam.timedOut
          ? "Exam finished (time is over)"
          : "Exam finished";
      }

      updateTimerDisplay();
    }

    function startExam() {
      if (!state.loaded || !state.allQuestions.length) return;

      const totalAvailable = state.allQuestions.length;
      let countSetting = state.exam.config.questionCount;
      let useCount = totalAvailable;

      if (countSetting !== "all") {
        const parsed = parseInt(countSetting, 10);
        if (!Number.isNaN(parsed) && parsed > 0) {
          useCount = Math.min(parsed, totalAvailable);
        }
      }

      const pool = state.allQuestions.slice();
      shuffleArray(pool);
      const selected = pool.slice(0, useCount);

      state.questions = selected;
      state.answers = selected.map(() => ({ selected: null, isCorrect: null }));
      state.currentIndex = 0;

      const durationMin = state.exam.config.durationMinutes;
      state.exam.active = true;
      state.exam.finished = false;
      state.exam.timedOut = false;

      clearExamTimer();

      if (durationMin > 0) {
        state.exam.totalSeconds = durationMin * 60;
        state.exam.remainingSeconds = state.exam.totalSeconds;
        startExamTimer();
      } else {
        state.exam.totalSeconds = 0;
        state.exam.remainingSeconds = 0;
      }

      elResult.hidden = true;
      elQuiz.hidden = false;
      updateExamStatus();
      renderCurrentQuestion();
      updateScorePreview();
    }

    function resetExam() {
      clearExamTimer();
      state.exam.active = false;
      state.exam.finished = false;
      state.exam.timedOut = false;
      state.exam.totalSeconds = 0;
      state.exam.remainingSeconds = 0;

      state.questions = [];
      state.answers = [];
      state.currentIndex = 0;

      updateExamStatus();
      renderCurrentQuestion();
      updateScorePreview();
    }

    function finishExam(timedOut = false) {
      if (state.exam.finished) return;

      state.exam.active = false;
      state.exam.finished = true;
      state.exam.timedOut = !!timedOut;
      clearExamTimer();

      if (state.questions.length > 0) {
        state.answers.forEach((aState, idx) => {
          const q = state.questions[idx];
          if (!q) return;
          aState.isCorrect = aState.selected === q.answer;
        });
      }

      updateExamStatus();
      updateScorePreview();
      showResult(timedOut);
    }

    // ====== SCORE PREVIEW ======
    function updateScorePreview() {
      const total = state.questions.length;
      if (!state.loaded || !total) {
        elScorePreview.textContent = "No questions loaded";
        return;
      }

      if (state.mode === MODES.PRACTICE) {
        const checked = state.answers.filter((a) => a.isCorrect !== null).length;
        const correct = state.answers.filter((a) => a.isCorrect === true).length;
        if (checked === 0) {
          elScorePreview.textContent = "No answers checked yet";
        } else {
          elScorePreview.textContent = `${correct} / ${checked} correct`;
        }
      } else {
        if (!state.exam.active && !state.exam.finished) {
          elScorePreview.textContent = "Exam not started";
        } else if (state.exam.active && !state.exam.finished) {
          const answered = state.answers.filter(
            (a) => a.selected !== null
          ).length;
          elScorePreview.textContent = `Answered ${answered} / ${total}`;
        } else if (state.exam.finished) {
          const correct = state.answers.filter(
            (a) => a.isCorrect === true
          ).length;
          elScorePreview.textContent = `Correct ${correct} / ${total}`;
        }
      }
    }

    // ====== RENDER CURRENT QUESTION ======
    function renderCurrentQuestion() {
      const total = state.questions.length;

      // exam mode & exam not started yet
      if (state.mode === MODES.EXAM && !state.exam.active && !state.exam.finished) {
        elQuestionCounter.textContent = "Exam not started";
        elProgressBar.style.width = "0%";
        elQuestionMeta.textContent =
          "Adjust exam settings above and press ‚ÄúStart exam‚Äù.";
        elQuestionText.textContent = "‚Äì";
        elOptions.innerHTML = "";
        btnPrev.disabled = true;
        btnMain.textContent = "Start exam";
        setWarning(false);
        return;
      }

      if (!total || state.currentIndex < 0 || state.currentIndex >= total) {
        // nothing to show
        elQuestionCounter.textContent = "No questions";
        elProgressBar.style.width = "0%";
        elQuestionMeta.textContent = "";
        elQuestionText.textContent = "No question data.";
        elOptions.innerHTML = "";
        btnPrev.disabled = true;
        btnMain.textContent =
          state.mode === MODES.EXAM ? "Start exam" : "Check answer";
        setWarning(false);
        return;
      }

      const q = state.questions[state.currentIndex];
      const aState = state.answers[state.currentIndex];

      const indexDisplay = state.currentIndex + 1;
      elQuestionCounter.textContent = `Question ${indexDisplay} of ${total}`;
      elProgressBar.style.width = `${(indexDisplay / total) * 100}%`;

      elQuestionMeta.textContent = `ID: ${q.id ?? q._index ?? indexDisplay}`;
      elQuestionText.textContent =
        q.question ?? "Question text is missing (check JSON).";

      // Options
      elOptions.innerHTML = "";
      const optionsObj = q.options || {};
      const entries = Object.entries(optionsObj).sort((a, b) =>
        a[0].localeCompare(b[0])
      );

      entries.forEach(([letter, text]) => {
        const optionEl = document.createElement("div");
        optionEl.className = "option";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "option-btn";
        btn.dataset.letter = letter;

        const letterSpan = document.createElement("div");
        letterSpan.className = "option-letter";
        letterSpan.textContent = letter;

        const textSpan = document.createElement("div");
        textSpan.className = "option-text";
        textSpan.textContent = text;

        btn.appendChild(letterSpan);
        btn.appendChild(textSpan);
        optionEl.appendChild(btn);

        const statusIcon = document.createElement("div");
        statusIcon.className = "option-status-icon";
        optionEl.appendChild(statusIcon);

        btn.addEventListener("click", () => handleOptionClick(letter));

        elOptions.appendChild(optionEl);
      });

      applyOptionStyles();

      // Buttons & main button label
      if (state.mode === MODES.PRACTICE) {
        btnPrev.disabled = state.currentIndex === 0;
        const last = state.currentIndex === total - 1;
        if (aState.isCorrect === null) {
          btnMain.textContent = "Check answer";
        } else {
          btnMain.textContent = last ? "Finish practice" : "Next question";
        }
      } else {
        // Exam mode
        const last = state.currentIndex === total - 1;
        if (state.exam.active && !state.exam.finished) {
          btnPrev.disabled = state.currentIndex === 0;
          btnMain.textContent = last ? "Finish exam" : "Next";
        } else if (state.exam.finished) {
          btnPrev.disabled = state.currentIndex === 0;
          btnMain.textContent = last ? "Back to summary" : "Next question";
        }
      }

      setWarning(false);
    }

    function applyOptionStyles() {
      const total = state.questions.length;
      if (!total || state.currentIndex < 0 || state.currentIndex >= total) return;

      const aState = state.answers[state.currentIndex];
      const q = state.questions[state.currentIndex];

      const optionNodes = elOptions.querySelectorAll(".option");
      optionNodes.forEach((optionEl) => {
        const btn = optionEl.querySelector(".option-btn");
        const icon = optionEl.querySelector(".option-status-icon");
        const letter = btn.dataset.letter;

        optionEl.classList.remove("option-selected");
        btn.classList.remove("option-correct", "option-wrong");
        icon.textContent = "";
        icon.className = "option-status-icon";

        if (aState.selected === letter) {
          optionEl.classList.add("option-selected");
        }

        if (aState.isCorrect !== null) {
          if (letter === q.answer) {
            btn.classList.add("option-correct");
            icon.textContent = "‚úî";
            icon.classList.add("correct");
          } else if (letter === aState.selected) {
            btn.classList.add("option-wrong");
            icon.textContent = "‚úñ";
            icon.classList.add("wrong");
          }
        }
      });
    }

    // ====== HANDLERS ======
    function handleOptionClick(letter) {
      const total = state.questions.length;
      if (!total || state.currentIndex < 0 || state.currentIndex >= total) return;

      const aState = state.answers[state.currentIndex];

      // In both practice and exam review we freeze answers after we know correct
      if (aState.isCorrect !== null) return;
      if (state.mode === MODES.EXAM && state.exam.finished) return;

      aState.selected = letter;
      applyOptionStyles();
      setWarning(false);
      if (state.mode === MODES.EXAM && state.exam.active) {
        // live update answered count
        updateScorePreview();
      }
    }

    function handlePrev() {
      if (state.currentIndex <= 0) return;
      state.currentIndex -= 1;
      renderCurrentQuestion();
      updateScorePreview();
    }

    function handleMainPractice() {
      const total = state.questions.length;
      if (!total) return;

      const aState = state.answers[state.currentIndex];
      const q = state.questions[state.currentIndex];
      const last = state.currentIndex === total - 1;

      if (aState.isCorrect === null) {
        // check
        if (!aState.selected) {
          setWarning(true);
          return;
        }
        aState.isCorrect = aState.selected === q.answer;
        applyOptionStyles();
        updateScorePreview();

        const newLast = state.currentIndex === total - 1;
        if (newLast) {
          btnMain.textContent = "Finish practice";
        } else {
          btnMain.textContent = "Next question";
        }
      } else {
        // already checked, move next or finish
        if (!last) {
          state.currentIndex += 1;
          renderCurrentQuestion();
          updateScorePreview();
        } else {
          showResult(false);
        }
      }
    }

    function handleMainExam() {
      if (!state.exam.active && !state.exam.finished) {
        // start exam
        startExam();
        return;
      }

      const total = state.questions.length;
      if (!total) return;

      if (state.exam.active && !state.exam.finished) {
        const aState = state.answers[state.currentIndex];
        const last = state.currentIndex === total - 1;

        if (!aState.selected) {
          setWarning(true);
          return;
        }

        if (!last) {
          state.currentIndex += 1;
          renderCurrentQuestion();
          updateScorePreview();
        } else {
          finishExam(false);
        }
      } else if (state.exam.finished) {
        // review mode
        const last = state.currentIndex === total - 1;
        if (!last) {
          state.currentIndex += 1;
          renderCurrentQuestion();
        } else {
          // back to summary screen
          elQuiz.hidden = true;
          elResult.hidden = false;
        }
      }
    }

    function handleMainButton() {
      if (state.mode === MODES.PRACTICE) {
        handleMainPractice();
      } else {
        handleMainExam();
      }
    }

    function handleSoftRestart() {
      if (!state.loaded || !state.allQuestions.length) return;

      if (state.mode === MODES.PRACTICE) {
        enterPracticeMode();
      } else {
        const needConfirm =
          state.exam.active || state.exam.finished || state.questions.length;
        if (needConfirm) {
          const ok = confirm(
            "Reset exam session? Current answers will be lost."
          );
          if (!ok) return;
        }
        resetExam();
      }
    }

    function showResult(timedOut = false) {
      elQuiz.hidden = true;
      elResult.hidden = false;

      const total = state.questions.length;
      const correct = state.answers.filter((a) => a.isCorrect === true).length;
      const percent = total ? Math.round((correct / total) * 100) : 0;

      elResultCorrect.textContent = correct;
      elResultTotal.textContent = total;
      elResultPercent.textContent = percent;

      let label;
      if (percent >= 90) {
        label =
          state.mode === MODES.EXAM
            ? "Philosophy god-mode ü§Ø"
            : "Insane performance, keep it!";
      } else if (percent >= 75) {
        label =
          state.mode === MODES.EXAM
            ? "Strong result ‚Äî ready for the real exam."
            : "Very good, a bit more drilling and you‚Äôre perfect.";
      } else if (percent >= 60) {
        label =
          state.mode === MODES.EXAM
            ? "Not bad, but you should review the weak spots."
            : "Okay as practice, but you can push this higher.";
      } else {
        label =
          state.mode === MODES.EXAM
            ? "Treat this as a diagnostic attempt. Time to revise theory."
            : "Good warm-up, but you definitely need more practice.";
      }

      elResultLabel.textContent = label;

      if (state.mode === MODES.EXAM) {
        const unanswered = state.answers.filter(
          (a) => a.selected === null
        ).length;
        let extra = `Exam mode. Correct: ${correct}, wrong: ${
          total - correct
        }, unanswered: ${unanswered}.`;
        if (timedOut) {
          extra += " The exam was auto-submitted when time ran out.";
        }
        elResultDetails.textContent = extra;
      } else {
        const wrong = total - correct;
        elResultDetails.textContent = `Practice mode. Correct: ${correct}, wrong: ${wrong}. You can restart or review each question with highlighted answers.`;
      }
    }

    // ====== DATA LOAD ======
    async function loadQuestions() {
      showLoading(true);
      showError(null);

      try {
        const res = await fetch("philosophy_all_questions.json", {
          cache: "no-store",
        });

        if (!res.ok) {
          throw new Error("HTTP " + res.status + " ‚Äî " + res.statusText);
        }

        const data = await res.json();
        if (!Array.isArray(data)) {
          throw new Error("Expected an array of questions in JSON.");
        }
        if (data.length === 0) {
          throw new Error("JSON file contains no questions.");
        }

        state.allQuestions = data.map((q, index) => ({
          ...q,
          _index: index + 1,
        }));

        state.loaded = true;
        showLoading(false);
        elQuiz.hidden = false;
        elResult.hidden = true;

        // Enter default mode (practice) using full set
        enterPracticeMode();
      } catch (err) {
        console.error("JSON load error:", err);
        showLoading(false);
        showError(err.message || "Unknown error while loading JSON.");
      }
    }

    // ====== EVENT LISTENERS ======
    btnPrev.addEventListener("click", handlePrev);
    btnMain.addEventListener("click", handleMainButton);
    btnRestartSoft.addEventListener("click", handleSoftRestart);
    btnRestart.addEventListener("click", () => {
      if (state.mode === MODES.PRACTICE) {
        enterPracticeMode();
      } else {
        resetExam();
        startExam();
      }
      elResult.hidden = true;
      elQuiz.hidden = false;
    });
    btnReview.addEventListener("click", () => {
      if (!state.loaded || !state.questions.length) return;
      state.currentIndex = 0;
      elResult.hidden = true;
      elQuiz.hidden = false;
      renderCurrentQuestion();
      updateScorePreview();
    });

    // Mode toggle
    btnModePractice.addEventListener("click", () => setMode(MODES.PRACTICE));
    btnModeExam.addEventListener("click", () => setMode(MODES.EXAM));

    // Exam config
    examQuestionCountSelect.addEventListener("change", () => {
      state.exam.config.questionCount = examQuestionCountSelect.value;
    });
    examDurationSelect.addEventListener("change", () => {
      const val = parseInt(examDurationSelect.value, 10);
      state.exam.config.durationMinutes = Number.isNaN(val) ? 0 : val;
    });
    // init config from default select values
    state.exam.config.questionCount = examQuestionCountSelect.value;
    state.exam.config.durationMinutes =
      parseInt(examDurationSelect.value, 10) || 0;

    // Enter key ‚Äî main action
    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        if (
          e.target &&
          (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA")
        ) {
          return;
        }
        e.preventDefault();
        if (!elQuiz.hidden) {
          handleMainButton();
        }
      }
    });

    // Initial UI state
    updateUIForMode();
    loadQuestions();
  </script>
</body>
</html>
